## 作业逻辑实现（优化与细化）

作业设计通常限制较宽松，用户可以反复访问，但仍需保证作业内容和提交的真实性与完整性。以下方案在前述基础上进一步细化，确保端到端的签名验证、时间戳和审计链，同时兼顾用户体验。

### 设计契约（简述）
- 输入：教师通过浏览器表单创建的作业描述（结构化 JSON，支持多种题型）；学生通过浏览器填写的作业答案（根据题型不同，如选择、文本、代码等）。
- 输出：教师签名并打包的 `.homework` 文件（GZ 压缩 + 签名封装），学生签名并打包的提交（同样格式），由服务器存储并提供审计与验证记录。
- 错误模式：签名不匹配、时间戳不可信、私钥不可用/解锁失败、前端校验失败、压缩/解压出错、题型不匹配。

成功判定：教师签名正确、时间戳在允许区间内、学生提交包含教师定义的正确响应（客观题直接比对，主观题关键词匹配或人工评分），并在服务器上记录不可篡改的审计条目（例如追加到日志或发送到时间戳/审计服务）。

### 数据格式规范（推荐 JSON Schema）

1) 教师作业描述（未压缩/未签名前的 JSON）：

```json
{
    "meta": {
        "version": "1.0",
        "class": "班级ID",
        "teacher": "教师ID",
        "created_at": "2025-09-22T21:00:00Z",
        "start_time": "2025-09-22T00:00:00Z",
        "end_time": "2025-10-22T23:59:59Z",
        "type": "online"
    },
    "items": [
        {
            "id": "q1",
            "type": "single_choice",
            "title": "题目标题",
            "details": ["多行文本..."],
            "options": ["选项A", "选项B", "选项C", "选项D"],
            "correct_answer": "A"
        },
        {
            "id": "q2",
            "type": "multiple_choice",
            "title": "题目标题",
            "details": ["多行文本..."],
            "options": ["选项A", "选项B", "选项C", "选项D"],
            "correct_answers": ["A", "C"]
        },
        {
            "id": "q3",
            "type": "true_false",
            "title": "题目标题",
            "details": ["多行文本..."],
            "correct_answer": true
        },
        {
            "id": "q4",
            "type": "fill_blank",
            "title": "题目标题",
            "details": ["请填写 ___ 的答案。"],
            "correct_answers": ["正确答案"]
        },
        {
            "id": "q5",
            "type": "short_answer",
            "title": "题目标题",
            "details": ["多行文本..."],
            "keywords": ["关键词1", "关键词2"]
        },
        {
            "id": "q6",
            "type": "code",
            "title": "题目标题",
            "details": ["多行文本..."],
            "selected_language": "python",
            "expected_responses": [
                { "input": "input text", "match": "include" }
            ]
        },
        {
            "id": "q7",
            "type": "essay",
            "title": "题目标题",
            "details": ["多行文本..."],
            "word_limit": 500
        }
    ]
}
```

题型说明：
- `single_choice`: 单选题，options 为选项列表，correct_answer 为正确选项ID（A、B等）。
- `multiple_choice`: 多选题，options 为选项列表，correct_answers 为正确选项ID数组。
- `true_false`: 判断题，correct_answer 为 true 或 false。
- `fill_blank`: 填空题，details 中用 ___ 表示空白，correct_answers 为正确答案数组（支持多个空白）。
- `short_answer`: 简答题，keywords 为关键词列表，用于匹配答案。
- `code`: 代码题，selected_language 为编程语言，expected_responses 为测试用例。
- `essay`: 作文题，word_limit 为最少字数限制。

最终打包：浏览器/客户端对该 JSON 使用教师私钥签名（detached signature），将 JSON 与签名一起 GZIP 压缩，文件名后缀 `.homework`。同时请求digicert可信时间戳服务以得到时间戳票据。

1) 学生提交（原始 JSON）：

```json
{
    "meta": {
        "version": "1.0",
        "class": "班级ID",
        "student": "学生ID",
        "submit_time": "2025-09-22T21:00:00Z",
        "type": "online"
    },
    "results": [
        {
            "question_id": "q1",
            "response": "A"
        },
        {
            "question_id": "q2",
            "response": ["A", "C"]
        },
        {
            "question_id": "q3",
            "response": true
        },
        {
            "question_id": "q4",
            "response": ["正确答案"]
        },
        {
            "question_id": "q5",
            "response": "学生简答文本"
        },
        {
            "question_id": "q6",
            "response": "base64编码的代码字符串",
            "check": "success|fail"
        },
        {
            "question_id": "q7",
            "response": "学生作文文本"
        }
    ]
}
```

response 字段根据题型调整：
- 单选题：字符串，如 "A"。
- 多选题：数组，如 ["A", "C"]。
- 判断题：布尔值。
- 填空题：数组，匹配空白数量。
- 简答题：字符串。
- 代码题：base64 编码的代码字符串，保留 check 字段。
- 作文题：字符串。

学生提交同样由学生私钥签名并 gzip 压缩为 `.submission`。

注意：所有签名都采用标准算法（例如 RSASSA-PSS + SHA-256 或 ECDSA over P-256 + SHA-256），并使用 OpenPGP 或 JOSE（建议在实现中统一选用一种）。

### 前端与后端分工（细化）

总体原则：避免让用户手动处理密钥或签名细节。密钥在注册阶段自动生成并安全保管；签名通常在客户端（浏览器）完成以保证私钥不出境，后端只在必要时提供密钥存储/解密服务（例如服务器端托管私钥时需要额外的安全控制）。

前端（浏览器）职责：
- 在用户注册/首次登录时，通过 WebCrypto 或 OpenPGP.js 生成一对公私钥（或从后端拉取经加密的私钥并在客户端解密）。
- 将公钥上报给后端进行绑定与分发（后端维护教师/学生的公钥目录并对公钥做审计）。
- 使用私钥对教师的作业 JSON 或学生提交进行签名（detached signature）。签名由浏览器在用户会话期间透明完成；常见实现：在用户点击“发布/提交”时无额外操作地完成签名。
- 根据题型渲染不同的输入组件：单选题使用 radio buttons，多选题使用 checkboxes，判断题使用 true/false buttons，填空题使用 input fields，简答题和作文题使用 textareas，代码题使用代码编辑器。
- 提供前端校验（可选快速反馈）：对于代码题，执行教师定义的测试用例；对于客观题（如单选、多选、判断），即时检查答案；对于主观题，提供关键词匹配提示。注意：前端校验不替代后端校验，后端应做二次验证。
- 对文件进行 gzip 压缩（浏览器内可用 pako 等库）并上传到后端，或导出 `.homework` 文件供离线分发。

后端职责：
- 存储并索引教师/学生的公钥、作业、提交记录、时间戳票据和审计日志。
- 提供可信时间戳服务端代理（如果使用外部时间戳机构，后端负责与其通信并保存时间戳证据）。
- 在收到作业/提交后，验证签名（使用存储的公钥）、验证时间戳、解压并记录不可篡改的审计条目（例如写入追加日志、数据库或转写到外部审计服务）。
- 执行后端校验：根据题型进行不同校验——客观题直接比对答案，主观题使用关键词匹配或 AI 评分（可选），代码题在沙箱内运行测试用例。
- 计算分数：客观题自动评分，主观题可手动或半自动评分。
- 提供密钥管理选项（见下）：私钥是否永远仅在客户端存储，或允许存储加密私钥在服务器端以便跨设备/恢复。

### 密钥与证书管理（用户无感知的实现方式）

- 在客户端（浏览器）生成密钥对。
- 私钥在客户端使用用户登录密码派生密钥（PBKDF2 / Argon2）加密后上传并存储到服务器（私钥密文）。公钥明文上传并绑定到账号。
- 用户登录时，客户端使用用户密码派生密钥自动解密私钥到浏览器内存，签名操作由浏览器完成，对用户透明（无需额外输入）。
- 优点：私钥不会以明文保留在服务器；用户可跨设备恢复（需密码）。缺点：依赖用户密码强度；建议强制二步验证和密码策略。


钥匙轮换/撤销：后端维护公钥版本、撤销状态与发布历史（类似证书透明日志）。当教师更换密钥时，旧公钥加入撤销列表并存储替代公钥及生效时间。

时间戳与可信验证：
- 对教师签名与学生签名同时请求可信时间戳服务（可由后端代理外部 TSA 或内部记录签名时间并写入审计日志）。时间戳证据随文件一并保存，便于事后举证。

### 签名与验证流程（端到端示例）

教师发布作业（浏览器端流程）：
1. 教师在浏览器内填写作业 JSON。
2. 浏览器使用本地私钥对 JSON 生成 detached signature（例如 OpenPGP detached 或 JWS signature）。
3. 浏览器请求后端的时间戳代理并将签名的摘要发送给后端获取时间戳票据（可异步）。
4. 浏览器将 {JSON, signature, timestamp_proof} gzip 打包为 `.homework` 并上传或导出。

后端收到 `.homework`：
1. 解压并提取 JSON、signature 与 timestamp_proof。
2. 通过教师绑定的公钥验证签名；若不匹配，拒绝并记录事件。
3. 验证时间戳票据（若存在）。
4. 记录审计条目（包含上传 IP、文件摘要、公钥指纹与时间戳），并将作业标记为发布。

学生收到作业并开始（浏览器端）：
1. 浏览器从后端拉取作业 JSON 与签名（或接收离线文件并解包）。
2. 浏览器使用教师公钥验证签名；若失败提示“作业已被篡改或签名无效”，并禁止参加。
3. 检查时间范围（start_time/end_time）与时间戳，若与证书服务器或后端时间策略冲突，阻止开始并提示原因。

学生提交（浏览器端）：
1. 学生在浏览器完成作答后，前端先运行快速本地校验以给出即时反馈。
2. 构造提交 JSON，浏览器使用学生私钥签名并向digicert请求时间戳证据。
3. gzip 打包并上传到后端。后端执行签名/时间戳校验，然后记录审计条目并返回结果给前端。

### 后端 API 建议（示例）

- POST /api/v1/homework/create  — 接收上传的 `.homework`（或 JSON + signature + timestamp），返回发布记录 id。
- GET /api/v1/homework/:id — 返回作业 JSON、signature 与元数据（供学生前端验证）。
- POST /api/v1/submissions — 接收学生签名的提交包，返回校验与评分结果。
- GET /api/v1/keys/:userid — 返回该用户已注册并验证的公钥（只读）。
- POST /api/v1/timestamp — 后端代理请求时间戳机构（TSA），返回时间戳证明。

所有 API 都应对上传文件计算并返回文件摘要（SHA-256），并在响应中包含服务器端的审计 id（用于后续查询与取证）。

### 前端实现要点（技术选型与 UX）

- 建议使用 OpenPGP.js 或 webcrypto + jose，选择已维护的库来处理签名/验证，避免自研加密实现。
- 压缩：在浏览器中使用 pako 等库进行 gzip 压缩/解压。
- 私钥保管：使用 IndexedDB 存储本地私钥密文（若采用方案 A，则私钥密文可同步到服务器）；在内存中仅解密短时间供签名使用，签名后立即清除明文私钥。
- UX：绝大多数操作对用户透明。仅在初次注册、恢复或敏感操作（更换密钥、导出私钥）时提供明确引导。

示例交互：教师点击“发布” → 浏览器在后台签名并上传 → 页面展示“发布成功（签名已验证）”和发布 ID；学生点击“开始作业” → 浏览器自动验证签名并检查时间 → 允许/拒绝。

### 离线发布 / 离线提交流程

- 离线发布：教师在浏览器生成 `.homework` 文件（含签名与时间戳证明），将其导出（通过文件、U盘、邮件等）。学生离线接收后，在浏览器本地解压并验证签名与时间戳。
- 离线提交：学生在本地生成签名的提交文件并离线交付（例如教师收集），教师或管理员在网页访问时抓取学生的公钥并校验。

注意：离线场景仅为教师和学生不将作业提交到服务器中，校验场景仍然需要联网以获取密钥。

### 防篡改与审计（强制手段）

- 在 UI 明示签名指纹、公钥 ID 与时间戳摘要；让用户在怀疑时能快速对比。

### 错误处理与常见边界情况

- 签名不匹配：提示“签名无效或公钥发生变更”，并阻止操作；同时记录事件并向管理员发警报。
- 时间戳缺失或与服务器时间明显冲突：视作风险，阻止开始并提示需联网校验。
- 私钥解密失败（密码错误或密钥损坏）：提供恢复流程（使用备份种子或要求管理员触发密钥恢复策略）。
- 前端压缩/解压失败：提示并建议重新上传或使用小文件拆分。

### 小结与实现建议清单

1. 使用浏览器端生成/使用密钥，用户不需要手动加密操作（默认方案 A）。
2. 教师在浏览器签名作业并上传；学生在浏览器验证签名并完成作业后签名提交，后端做二次验证与沙箱执行（针对代码题）。
3. 支持多种题型：单选题、多选题、判断题、填空题、简答题、代码题、作文题，根据题型调整前端组件和后端校验逻辑。
4. 使用 detached signature + gzip 封装为 `.homework`，并同时保存时间戳票据用于不可否认性。 
5. 离线场景支持文件导入/导出，但要求补写时间戳和联网获取公钥指纹以提升可信度。

本方案在保证用户体验（教师/学生无需掌握加密细节）的同时，提供端到端签名验证、时间戳与审计链，能够有效抵抗篡改并满足教育场景的可追溯性，支持多样化的题型以适应不同教学需求。

## 考试逻辑实现

考试需要严格的时间控制和防作弊措施，用户只能访问页面一次，且在考试时间结束后无法再提交答案。以下是实现方案，优先推荐使用 Microsoft 的 ms-edu-secureassessment 特性作为核心防作弊手段。

### 设计契约（简述）
- 输入：教师通过浏览器表单创建的考试描述（结构化 JSON）；学生通过浏览器填写的考试答案（代码或文本）。
- 输出：教师签名并打包的 `.exam` 文件（GZ 压缩 + 签名封装），学生签名并打包的提交（同样格式），由服务器存储并提供审计与验证记录。
- 错误模式：签名不匹配、时间戳不可信、私钥不可用/解锁失败、前端校验失败、压缩/解压出错、考试时间过期、重复访问。
- 成功判定：教师签名正确、时间戳在允许区间内、学生提交在考试时间内完成并包含正确响应，后端验证通过，并记录不可篡改的审计条目。
- 作弊防范：考试设计不允许离线分发，要求在受控环境下进行（如学校多媒体教室），并使用 ms-edu-secureassessment 锁定设备。

### 数据格式规范（推荐 JSON Schema）

1) 教师考试描述（未压缩/未签名前的 JSON）：

```json
{
    "meta": {
        "version": "1.0",
        "class": "班级ID",
        "teacher": "教师ID",
        "created_at": "2025-09-22T21:00:00Z",
        "start_time": "2025-09-22T09:00:00Z",
        "end_time": "2025-09-22T11:00:00Z",
        "type": "exam",
        "duration_minutes": 120,
        "allow_multiple_access": false,
        "admin_password": "教师设置的管理密码哈希"
    },
    "items": [
        {
            "id": "q1",
            "title": "题目标题",
            "details": ["多行文本..."],
            "selected_language": "python",
            "expected_responses": [
                { "input": "input text", "match": "include" }
            ]
        }
    ]
}
```

最终打包：浏览器/客户端对该 JSON 使用教师私钥签名（detached signature），将 JSON 与签名一起 GZIP 压缩，文件名后缀 `.exam`。同时请求可信时间戳服务以得到时间戳票据。

2) 学生提交（原始 JSON）：

```json
{
    "meta": {
        "version": "1.0",
        "class": "班级ID",
        "student": "学生ID",
        "submit_time": "2025-09-22T10:50:00Z",
        "exam_id": "考试ID",
        "type": "exam"
    },
    "results": [
        {
            "question_id": "q1",
            "test": "base64(教师题目JSON)",
            "response": "base64(学生代码或文本)",
            "check": "success|fail"
        }
    ]
}
```

为降低负载，学生的考试提交为直接JSON。

### 外部管理
考试应当由教师组织，教师负责创建考试、分发考试链接和管理考试时间。考试链接应包含唯一的考试ID和学生ID，以确保每个学生只能访问自己的考试。

为确保考试成绩可信，教师应当在学校的多媒体教室内组织考试，并确保运行测试的计算机为Windows 10/Windows 11 SE 或 Windows 11。当学生参加考试时，教师应当在场监督，确保学生在考试过程中不使用任何外部资源。

教师应提前设置管理密码，用于处理重复访问或异常情况。考试环境应优先使用 ms-edu-secureassessment，以锁定设备并防止作弊。

### 前端实现
前端应当使用Vue 3和TypeScript实现，确保页面在考试期间不可刷新或关闭。使用浏览器API（如 `beforeunload` 事件）阻止页面关闭或刷新，每隔，并在考试期间禁用右键菜单、复制粘贴等功能。

**优先推荐：集成 ms-edu-secureassessment**
- ms-edu-secureassessment 是 Microsoft 提供的“参加测验”特性，专为教育考试设计，能够创建受控的考试环境。
- 实现方式：将以下链接嵌入到考试页面中：
  ```
  ms-edu-secureassessment:<URL>#enforcelockdown&enableTextSuggestion
  ```
  其中 `<URL>` 为考试页面的完整URL，为便于管理，建议新建一个页面`/exam`，访问该页面时会提示学生登录，并在登录后自动跳转到考试页面。
  因此链接可写作：

    ```
    ms-edu-secureassessment:https://yourdomain.com/exam#enforcelockdown&enableTextSuggestion
    ```
- 学生点击该链接后，系统将进入锁定模式：禁用其他应用程序、浏览器标签页、系统快捷键等，学生只能在指定页面内操作。
- 教师可下载快捷方式分发给学生，确保考试环境一致。
- 前端应检测是否在 secure assessment 模式下运行，如果不是，提示学生启用该模式。
- 优点：高度防作弊，官方支持，适用于 Windows。

后端统计每个考生的页面访问次数，当不是第一次进入页面时，应要求输入来自教师设置的管理密码。如果密码正确，允许继续；否则，记录违规并阻止访问。

考试页面应显示倒计时，基于服务器时间同步。考试结束时，前端自动提交答案或锁定页面。
为防止答案丢失，前端应每10秒将答案上传到后端。

### 后端实现
后端应当确保考试时间严格受控。考试开始时，后端记录考试的开始时间，并在考试结束时自动关闭考试，防止学生在考试时间结束后提交答案。

- 时间控制：使用服务器时间作为权威时间，客户端定期同步。考试开始后，记录每个学生的访问时间和提交时间。
- 访问控制：为每个学生生成唯一链接，包含考试ID和学生ID。后端验证链接有效性，并跟踪访问次数（只允许打开一次，多次打开请求教师密码和教师设置的管理密码才能打开）。
- 保存记录：当教师授权学生重新进入答题时，加载之前的答案，允许继续答题。
- 管理密码：教师设置密码哈希存储，后端验证输入密码。
- 自动关闭：考试结束时，后端停止接受提交，并通知前端锁定页面。
- 其余设计参考作业实现，包括签名验证、时间戳、审计日志等。

### 前端与后端分工（细化）
前端职责：
- 集成 ms-edu-secureassessment 链接，确保学生进入受控环境。
- 防止页面刷新/关闭：使用 Vue 路由守卫和浏览器事件。
- 定时保存答案：每10秒将当前答案完整上传到后端。
- 显示考试倒计时，实时同步服务器时间。
- 处理重复访问：弹出密码输入框。
- 收集学生答案，签名并提交。

后端职责：
- 验证考试时间窗口。
- 跟踪访问次数和提交状态。
- 验证管理密码。
- 执行签名和时间戳验证。
- 记录审计日志，包括违规事件。

### 防作弊措施
- **首要措施**：使用 ms-edu-secureassessment 锁定环境。
- 页面访问控制：单次访问，密码重入。
- 时间严格控制：服务器和客户端强制结束。
- 审计日志：记录所有操作，包括IP、时间戳。
- 签名验证：确保提交真实性。

### 后端 API 建议（示例）
- POST /api/v1/exam/create — 接收上传的 `.exam`，返回考试ID。
- GET /api/v1/exam/:id/:student_id — 返回考试JSON、签名与元数据（验证后允许访问）。
- POST /api/v1/exam/submit — 接收学生提交，验证时间和签名，返回结果。
- POST /api/v1/exam/verify_access — 验证访问次数和密码。
- GET /api/v1/exam/time — 返回服务器当前时间，用于同步。

### 错误处理与边界情况
- 考试时间过期：阻止提交，显示“考试已结束”。
- 重复访问：要求密码，否则记录违规。
- 签名失败：提示“提交无效”，记录事件。
- ms-edu-secureassessment 未启用：警告学生启用。

### 小结与实现建议清单
1. 优先集成 ms-edu-secureassessment 作为防作弊核心。
2. 使用 Vue 3 前端实现页面锁定和时间控制。
3. 后端使用 FastAPI 管理时间、访问和验证。
4. 参考作业实现签名、时间戳和审计。
5. 测试在 Windows 教育版环境下的兼容性。

本方案通过 ms-edu-secureassessment 提供强力防作弊保障，同时结合后端控制和前端锁定，确保考试公平性和可追溯性。
